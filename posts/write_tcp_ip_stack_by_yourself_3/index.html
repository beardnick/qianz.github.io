<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Write TCP/IP Stack by Yourself (3): TCP Three-Way Handshake - </title><meta name="Description" content="Hugo theme even example site."><meta property="og:title" content="Write TCP/IP Stack by Yourself (3): TCP Three-Way Handshake" />
<meta property="og:description" content="Data Structures The main data structures of the project and their interactions are shown in the following diagram:
Dotted arrows represent asynchronous calls, implemented using Go&rsquo;s channel mechanism. If you want to implement this in another language, you&rsquo;ll need to use a thread-safe message queue to replace the channels. Network is mainly responsible for reading data packets from TUN, writing to TUN, binding socket and IP port information, and routing network packets to the appropriate socket for processing based on IP port information." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://beardnick.github.io/qianz.github.io/posts/write_tcp_ip_stack_by_yourself_3/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2025-02-19T09:56:13+08:00" />
<meta property="article:modified_time" content="2025-02-19T09:56:13+08:00" /><meta property="og:site_name" content="My cool site" />

<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Write TCP/IP Stack by Yourself (3): TCP Three-Way Handshake"/>
<meta name="twitter:description" content="Data Structures The main data structures of the project and their interactions are shown in the following diagram:
Dotted arrows represent asynchronous calls, implemented using Go&rsquo;s channel mechanism. If you want to implement this in another language, you&rsquo;ll need to use a thread-safe message queue to replace the channels. Network is mainly responsible for reading data packets from TUN, writing to TUN, binding socket and IP port information, and routing network packets to the appropriate socket for processing based on IP port information."/>
<meta name="application-name" content="My cool site">
<meta name="apple-mobile-web-app-title" content="My cool site"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://beardnick.github.io/qianz.github.io/posts/write_tcp_ip_stack_by_yourself_3/" /><link rel="prev" href="https://beardnick.github.io/qianz.github.io/posts/write_tcp_ip_stack_by_yourself_2/" /><link rel="next" href="https://beardnick.github.io/qianz.github.io/posts/write_tcp_ip_stack_by_yourself_4/" /><link rel="stylesheet" href="/qianz.github.io/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Write TCP/IP Stack by Yourself (3): TCP Three-Way Handshake",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/beardnick.github.io\/qianz.github.io\/posts\/write_tcp_ip_stack_by_yourself_3\/"
        },"genre": "posts","keywords": "tcp\/ip, network, linux","wordcount":  2983 ,
        "url": "https:\/\/beardnick.github.io\/qianz.github.io\/posts\/write_tcp_ip_stack_by_yourself_3\/","datePublished": "2025-02-19T09:56:13+08:00","dateModified": "2025-02-19T09:56:13+08:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "qianz"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/qianz.github.io/" title="">qianz</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/qianz.github.io/posts/" title="qianz"> Posts </a><a class="menu-item" href="/qianz.github.io/tags/"> Tags </a><a class="menu-item" href="/qianz.github.io/categories/"> Categories </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a><a href="javascript:void(0);" class="menu-item language" title="Select Language">
                    <i class="fa fa-globe" aria-hidden="true"></i>                      
                    <select class="language-select" id="language-select-desktop" onchange="location = this.value;"><option value="/qianz.github.io/posts/write_tcp_ip_stack_by_yourself_3/" selected>English</option><option value="/qianz.github.io/zh-cn/posts/write_tcp_ip_stack_by_yourself_3/">简体中文</option></select>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/qianz.github.io/" title="">qianz</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/qianz.github.io/posts/" title="qianz">Posts</a><a class="menu-item" href="/qianz.github.io/tags/" title="">Tags</a><a class="menu-item" href="/qianz.github.io/categories/" title="">Categories</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a><a href="javascript:void(0);" class="menu-item" title="Select Language">
                    <i class="fa fa-globe fa-fw" aria-hidden="true"></i>
                    <select class="language-select" onchange="location = this.value;"><option value="/qianz.github.io/posts/write_tcp_ip_stack_by_yourself_3/" selected>English</option><option value="/qianz.github.io/zh-cn/posts/write_tcp_ip_stack_by_yourself_3/">简体中文</option></select>
                </a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content always-active" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Write TCP/IP Stack by Yourself (3): TCP Three-Way Handshake</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/qianz.github.io/" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>qianz</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2025-02-19">2025-02-19</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;2983 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;15 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#data-structures">Data Structures</a></li>
    <li><a href="#three-way-handshake-and-four-way-handshake">Three-Way Handshake and Four-Way Handshake</a></li>
    <li><a href="#sequence-and-acknowledgment-number-calculation">Sequence and Acknowledgment Number Calculation</a></li>
    <li><a href="#relationship-between-send-window-receive-window-and-sequenceacknowledgment-numbers">Relationship between Send Window, Receive Window, and Sequence/Acknowledgment Numbers</a></li>
    <li><a href="#socket"><code>socket()</code></a>
      <ul>
        <li><a href="#half-connection-queue">Half-Connection Queue</a></li>
      </ul>
    </li>
    <li><a href="#bind"><code>bind()</code></a></li>
    <li><a href="#listen"><code>listen()</code></a></li>
    <li><a href="#three-way-handshake">Three-Way Handshake</a>
      <ul>
        <li><a href="#handling-syn-packet-in-passive-open">Handling SYN Packet in Passive Open</a></li>
        <li><a href="#connect"><code>connect()</code></a></li>
        <li><a href="#handling-synack-packet-in-active-open">Handling SYN+ACK Packet in Active Open</a></li>
      </ul>
    </li>
    <li><a href="#accept"><code>accept()</code></a></li>
    <li><a href="#summary">Summary</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="data-structures">Data Structures</h1>
<p>The main data structures of the project and their interactions are shown in the following diagram:</p>
<p><img
        class="lazyload"
        src="/qianz.github.io/svg/loading.min.svg"
        data-src="https://raw.githubusercontent.com/beardnick/static/master/images20250219120508.png"
        data-srcset="https://raw.githubusercontent.com/beardnick/static/master/images20250219120508.png, https://raw.githubusercontent.com/beardnick/static/master/images20250219120508.png 1.5x, https://raw.githubusercontent.com/beardnick/static/master/images20250219120508.png 2x"
        data-sizes="auto"
        alt="https://raw.githubusercontent.com/beardnick/static/master/images20250219120508.png"
        title="netstack_datastructure" /></p>
<ul>
<li>Dotted arrows represent asynchronous calls, implemented using Go&rsquo;s channel mechanism. If you want to implement this in another language, you&rsquo;ll need to use a thread-safe message queue to replace the channels.</li>
<li><code>Network</code> is mainly responsible for reading data packets from TUN, writing to TUN, binding socket and IP port information, and routing network packets to the appropriate socket for processing based on IP port information.</li>
<li><code>Socket</code> implements TCP protocol&rsquo;s connection management, data sending and receiving.</li>
<li>When you send a SYN request to TUN, the data packet flow is: <code>tun -&gt; Network -&gt; Socket(handle syn) -&gt; Socket(send syn ack) -&gt; Network -&gt; tun</code></li>
<li>After the connection is established, when sending data through the write interface, the packet flow is: <code>Socket(send data) -&gt; Network -&gt; tun</code></li>
</ul>
<h1 id="three-way-handshake-and-four-way-handshake">Three-Way Handshake and Four-Way Handshake</h1>
<p>You might find that the three-way handshake and four-way handshake processes are easy to forget, and the details during the handshake are unclear. Here&rsquo;s a simple approach to help you understand the handshake process.
In my understanding, there are two key points in TCP design:</p>
<ul>
<li>Every sent data message requires an ACK response from the other party. This includes data packets, SYN, FIN, etc.</li>
<li>TCP connections are full-duplex, so establishing a connection requires both parties to confirm receiving the other&rsquo;s information. A connection with only one party confirming is an intermediate state, called a half-open or half-closed connection.</li>
</ul>
<p>Understanding these two points, you&rsquo;ll see that the three-way handshake and four-way handshake processes are actually identical, just that the handshake sends SYN while the closing process sends FIN. It looks like this:</p>
<p><img
        class="lazyload"
        src="/qianz.github.io/svg/loading.min.svg"
        data-src="https://raw.githubusercontent.com/beardnick/static/master/images20250219130716.png"
        data-srcset="https://raw.githubusercontent.com/beardnick/static/master/images20250219130716.png, https://raw.githubusercontent.com/beardnick/static/master/images20250219130716.png 1.5x, https://raw.githubusercontent.com/beardnick/static/master/images20250219130716.png 2x"
        data-sizes="auto"
        alt="https://raw.githubusercontent.com/beardnick/static/master/images20250219130716.png"
        title="handshake" /></p>
<p>You might wonder, wouldn&rsquo;t this make the three-way handshake into a four-way handshake? This is because the designers combined the server&rsquo;s SYN and ACK packets into one packet to improve performance, turning it into a three-way handshake.
During connection termination, the server might still have data to send, so it can&rsquo;t combine FIN and ACK, resulting in a four-way handshake. The final process looks like this:</p>
<p><img
        class="lazyload"
        src="/qianz.github.io/svg/loading.min.svg"
        data-src="https://raw.githubusercontent.com/beardnick/static/master/images20250219130840.png"
        data-srcset="https://raw.githubusercontent.com/beardnick/static/master/images20250219130840.png, https://raw.githubusercontent.com/beardnick/static/master/images20250219130840.png 1.5x, https://raw.githubusercontent.com/beardnick/static/master/images20250219130840.png 2x"
        data-sizes="auto"
        alt="https://raw.githubusercontent.com/beardnick/static/master/images20250219130840.png"
        title="real_handshake" /></p>
<h1 id="sequence-and-acknowledgment-number-calculation">Sequence and Acknowledgment Number Calculation</h1>
<p>Sequence and acknowledgment numbers are another challenging aspect of the TCP protocol. In my understanding, you only need to remember one point:</p>
<ul>
<li>All individual data messages occupy one sequence number and one acknowledgment number. Data messages include data packets, SYN, FIN, etc.</li>
</ul>
<p>For example:</p>
<ul>
<li>During the three-way handshake, after sending the first SYN, the SYN occupies one sequence number, so the next packet from the client must use seq+1 as the sequence number. This means the first data packet&rsquo;s sequence number must be the initial sequence number plus 1.</li>
<li>During the four-way handshake, after sending the first FIN, the FIN occupies one sequence number, so the next packet from the client must use seq+1 as the sequence number. For the server, after receiving FIN, if it only sends an ACK (ACK is not a data message), then the server&rsquo;s next packet will still use the current sequence number, no need to add 1.</li>
<li>For data packets, each byte of data occupies one sequence number. If you send n bytes, the subsequent sequence number increases by n.</li>
</ul>
<p>The acknowledgment number can be remembered in relation to the sequence number, simply as <strong>the next sequence number the other party should send</strong>. So calculating the acknowledgment number becomes calculating what sequence number the peer should send.</p>
<h1 id="relationship-between-send-window-receive-window-and-sequenceacknowledgment-numbers">Relationship between Send Window, Receive Window, and Sequence/Acknowledgment Numbers</h1>
<p>Understanding sequence and acknowledgment numbers is crucial for understanding the sliding window. Here are the sliding window parameters defined in the RFC:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">SND.UNA send unacknowledged
</span></span><span class="line"><span class="cl">SND.NXT send next
</span></span><span class="line"><span class="cl">RCV.NXT receive next
</span></span></code></pre></td></tr></table>
</div>
</div><p>Translated:</p>
<ul>
<li>SND.UNA: The sequence number of sent but unacknowledged data</li>
<li>SND.NXT: The next sequence number to send, all data before this number has been sent</li>
<li>RCV.NXT: The next sequence number to receive, all data before this number has been received</li>
</ul>
<p>Looking at our earlier analysis of sequence and acknowledgment numbers, SND.NXT is our next sequence number to send, and RCV.NXT is the acknowledgment number. Let&rsquo;s look at a diagram:</p>
<p><img
        class="lazyload"
        src="/qianz.github.io/svg/loading.min.svg"
        data-src="https://raw.githubusercontent.com/beardnick/static/master/images20250219155820.png"
        data-srcset="https://raw.githubusercontent.com/beardnick/static/master/images20250219155820.png, https://raw.githubusercontent.com/beardnick/static/master/images20250219155820.png 1.5x, https://raw.githubusercontent.com/beardnick/static/master/images20250219155820.png 2x"
        data-sizes="auto"
        alt="https://raw.githubusercontent.com/beardnick/static/master/images20250219155820.png"
        title="tcp_window" /></p>
<p>Notice that I&rsquo;ve included SYN and FIN in the data boxes. Although they&rsquo;re not real data, they occupy sequence numbers, so including them in the data boxes makes it easier to understand.
Looking at the diagram, we can calculate the sequence and acknowledgment numbers the other party should send. Our acknowledgment number is <strong>the next sequence number the other party should send</strong>, and the other party&rsquo;s acknowledgment number is <strong>the next sequence number we should send</strong>.
However, the other party might not have received all our data, so their acknowledgment number might be smaller than our SND.NXT, it&rsquo;s a range. The other party shouldn&rsquo;t acknowledge the same data repeatedly, so their acknowledgment number range is <code>(SND.UNA, SND.NXT]</code>.
Note it&rsquo;s greater than <code>SND.UNA</code> because the acknowledgment is the next sequence number to send.</p>
<h1 id="socket"><code>socket()</code></h1>
<p>The <code>socket()</code> interface creates a socket object. Currently, we can only create TCP sockets, while the Linux kernel can create sockets for UDP and other protocols.
Here&rsquo;s the socket object implementation:</p>
<p><a href="https://github.com/beardnick/lab/blob/6365a837db2e19f3027e776692817eab51a01ad6/network/netstack/socket/socket.go#L13-L40" target="_blank" rel="noopener noreffer ">TcpSocket</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">SocketAddr</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">LocalIP</span>    <span class="kt">string</span>
</span></span><span class="line"><span class="cl">    <span class="nx">RemoteIP</span>   <span class="kt">string</span>
</span></span><span class="line"><span class="cl">    <span class="nx">LocalPort</span>  <span class="kt">uint16</span>
</span></span><span class="line"><span class="cl">    <span class="nx">RemotePort</span> <span class="kt">uint16</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">TcpSocket</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
</span></span><span class="line"><span class="cl">    <span class="nx">SocketAddr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">State</span> <span class="nx">tcpip</span><span class="p">.</span><span class="nx">TcpState</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">fd</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">network</span>  <span class="o">*</span><span class="nx">Network</span>
</span></span><span class="line"><span class="cl">    <span class="nx">listener</span> <span class="o">*</span><span class="nx">TcpSocket</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">acceptQueue</span> <span class="kd">chan</span> <span class="o">*</span><span class="nx">TcpSocket</span>
</span></span><span class="line"><span class="cl">    <span class="nx">synQueue</span>    <span class="nx">sync</span><span class="p">.</span><span class="nx">Map</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">readCh</span>  <span class="kd">chan</span> <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">    <span class="nx">writeCh</span> <span class="kd">chan</span> <span class="o">*</span><span class="nx">tcpip</span><span class="p">.</span><span class="nx">IPPack</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">recvNext</span>   <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sendNext</span>   <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sendUnack</span>  <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sendBuffer</span> <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Key fields to note:</p>
<ul>
<li>synQueue: The famous half-connection queue, used to store sockets that have received SYN but not ACK packets. Interestingly, it&rsquo;s a <code>map</code> here</li>
<li>acceptQueue: The famous full-connection queue, used to store sockets with established connections. Here it&rsquo;s a <code>channel</code> for asynchronously passing <code>socket</code> to the <code>accept</code> interface</li>
<li>recvNext: Next sequence number to receive</li>
<li>sendNext: Next sequence number to send</li>
<li>sendUnack: Sequence number of sent but unacknowledged data</li>
<li>sendBuffer: Send buffer for storing data to be sent</li>
</ul>
<h2 id="half-connection-queue">Half-Connection Queue</h2>
<p>The name suggests it should be a queue, but thinking carefully, half-connections don&rsquo;t receive the third handshake in first-in-first-out order, so why would it be a queue? Moreover, to find which half-connection received the third handshake, we clearly should use a map for storage.
I once tried to find the half-connection queue implementation in the Linux kernel source code, but the kernel code was convoluted with no explicit <code>syn queue</code>. It was quite confusing until I found the answer on Stack Overflow:
<a href="https://stackoverflow.com/questions/63232891/confusion-about-syn-queue-and-accept-queue" target="_blank" rel="noopener noreffer ">confusion-about-syn-queue-and-accept-queue</a>.
In short, the kernel doesn&rsquo;t have an explicit half-connection queue data structure. The functionality is carried by a hash table called <code>ehash</code>, which isn&rsquo;t specifically designed for half-connections and has other functions.
The full-connection queue does have a dedicated variable <code>icsk_accept_queue</code>.</p>
<h1 id="bind"><code>bind()</code></h1>
<p>The <code>bind()</code> interface binds a socket to a specified IP and port, specifically using a map in <code>Network</code> to associate <code>SocketAddr</code> with <code>TcpSocket</code>.</p>
<p><a href="https://github.com/beardnick/lab/blob/bda182aad77b7dc9890e73725b6d6957c436fad7/network/netstack/socket/net.go#L396-L398" target="_blank" rel="noopener noreffer ">bindSocket</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">n</span> <span class="o">*</span><span class="nx">Network</span><span class="p">)</span> <span class="nf">bindSocket</span><span class="p">(</span><span class="nx">addr</span> <span class="nx">SocketAddr</span><span class="p">,</span> <span class="nx">fd</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">n</span><span class="p">.</span><span class="nx">socketFds</span><span class="p">.</span><span class="nf">Store</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">fd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><a href="https://github.com/beardnick/lab/blob/bda182aad77b7dc9890e73725b6d6957c436fad7/network/netstack/socket/net.go#L371-L385" target="_blank" rel="noopener noreffer ">getSocket</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">n</span> <span class="o">*</span><span class="nx">Network</span><span class="p">)</span> <span class="nf">getSocket</span><span class="p">(</span><span class="nx">addr</span> <span class="nx">SocketAddr</span><span class="p">)</span> <span class="p">(</span><span class="nx">sock</span> <span class="o">*</span><span class="nx">TcpSocket</span><span class="p">,</span> <span class="nx">ok</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">value</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">socketFds</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">n</span><span class="p">.</span><span class="nf">getSocketByFd</span><span class="p">(</span><span class="nx">value</span><span class="p">.(</span><span class="kt">int</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">newAddr</span> <span class="o">:=</span> <span class="nx">SocketAddr</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">LocalIP</span><span class="p">:</span>   <span class="nx">addr</span><span class="p">.</span><span class="nx">LocalIP</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">LocalPort</span><span class="p">:</span> <span class="nx">addr</span><span class="p">.</span><span class="nx">LocalPort</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">value</span><span class="p">,</span> <span class="nx">ok</span> <span class="p">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">socketFds</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="nx">newAddr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">n</span><span class="p">.</span><span class="nf">getSocketByFd</span><span class="p">(</span><span class="nx">value</span><span class="p">.(</span><span class="kt">int</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The socket retrieval method is quite sophisticated. The logic is:</p>
<ol>
<li>First try to get the socket with key <code>[localIP, localPort, remoteIP, remotePort]</code>. If successful, it&rsquo;s either an established connection or a socket that initiated the connection</li>
<li>If not found, try with key <code>[localIP, localPort]</code>. This would be a listening socket</li>
<li>If not found, try with key <code>[localPort]</code>. This would be a socket listening on <code>0.0.0.0</code></li>
</ol>
<p>I haven&rsquo;t implemented the third logic, but it&rsquo;s straightforward to do so. Using this technique, our bind can handle all types of sockets flexibly.</p>
<h1 id="listen"><code>listen()</code></h1>
<p>The <code>listen()</code> interface sets the socket to listening state. Implementation:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">n</span> <span class="o">*</span><span class="nx">Network</span><span class="p">)</span> <span class="nf">listen</span><span class="p">(</span><span class="nx">fd</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">backlog</span> <span class="kt">uint</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sock</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">n</span><span class="p">.</span><span class="nf">getSocketByFd</span><span class="p">(</span><span class="nx">fd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;%w: %d&#34;</span><span class="p">,</span> <span class="nx">ErrNoSocket</span><span class="p">,</span> <span class="nx">fd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">InitListenSocket</span><span class="p">(</span><span class="nx">sock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">sock</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="nx">backlog</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">InitListenSocket</span><span class="p">(</span><span class="nx">sock</span> <span class="o">*</span><span class="nx">TcpSocket</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sock</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nx">sock</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sock</span><span class="p">.</span><span class="nx">synQueue</span> <span class="p">=</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Map</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sock</span><span class="p">.</span><span class="nx">readCh</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sock</span><span class="p">.</span><span class="nx">writeCh</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="o">*</span><span class="nx">tcpip</span><span class="p">.</span><span class="nx">IPPack</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sock</span><span class="p">.</span><span class="nx">State</span> <span class="p">=</span> <span class="nx">tcpip</span><span class="p">.</span><span class="nx">TcpStateListen</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">TcpSocket</span><span class="p">)</span> <span class="nf">Listen</span><span class="p">(</span><span class="nx">backlog</span> <span class="kt">uint</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">s</span><span class="p">.</span><span class="nx">acceptQueue</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="o">*</span><span class="nx">TcpSocket</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="nx">backlog</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">network</span><span class="p">.</span><span class="nx">opt</span><span class="p">.</span><span class="nx">SoMaxConn</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">go</span> <span class="nx">s</span><span class="p">.</span><span class="nf">runloop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">TcpSocket</span><span class="p">)</span> <span class="nf">runloop</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">data</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">s</span><span class="p">.</span><span class="nx">writeCh</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">tcpPack</span> <span class="o">:=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">Payload</span><span class="p">.(</span><span class="o">*</span><span class="nx">tcpip</span><span class="p">.</span><span class="nx">TcpPack</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">s</span><span class="p">.</span><span class="nf">handle</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">tcpPack</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">TcpSocket</span><span class="p">)</span> <span class="nf">handle</span><span class="p">(</span><span class="nx">ipPack</span> <span class="o">*</span><span class="nx">tcpip</span><span class="p">.</span><span class="nx">IPPack</span><span class="p">,</span> <span class="nx">tcpPack</span> <span class="o">*</span><span class="nx">tcpip</span><span class="p">.</span><span class="nx">TcpPack</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">s</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nx">s</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">network</span><span class="p">.</span><span class="nx">opt</span><span class="p">.</span><span class="nx">Debug</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;before handle %s:%d =&gt; %s:%d %s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">ipPack</span><span class="p">.</span><span class="nx">SrcIP</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">tcpPack</span><span class="p">.</span><span class="nx">SrcPort</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">ipPack</span><span class="p">.</span><span class="nx">DstIP</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">tcpPack</span><span class="p">.</span><span class="nx">DstPort</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">s</span><span class="p">.</span><span class="nx">State</span><span class="p">.</span><span class="nf">String</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">handleState</span><span class="p">(</span><span class="nx">ipPack</span><span class="p">,</span> <span class="nx">tcpPack</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;after handle %s:%d =&gt; %s:%d %s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ipPack</span><span class="p">.</span><span class="nx">SrcIP</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">tcpPack</span><span class="p">.</span><span class="nx">SrcPort</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ipPack</span><span class="p">.</span><span class="nx">DstIP</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">tcpPack</span><span class="p">.</span><span class="nx">DstPort</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">s</span><span class="p">.</span><span class="nx">State</span><span class="p">.</span><span class="nf">String</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">resp</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">data</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">resp</span><span class="p">.</span><span class="nf">Encode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">s</span><span class="p">.</span><span class="nx">network</span><span class="p">.</span><span class="nx">writeCh</span> <span class="o">&lt;-</span> <span class="nx">data</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Main logic:</p>
<ul>
<li>Initialize socket data, note that <code>acceptQueue</code>&rsquo;s length is <code>min(backlog, s.network.opt.SoMaxConn)</code></li>
<li>Start a goroutine (other languages would use threads, processes, or other concurrency mechanisms) to monitor <code>writeCh</code>. When data arrives (from <code>Network</code> reading from <code>Tun</code>), call the <code>handle</code> function to process it</li>
<li><code>handle</code> is responsible for locking, calling <code>handleState</code> to generate response packets, then passing response packets to <code>Network</code></li>
</ul>
<p>The design of <code>handle</code> and <code>handleState</code> functions is worth mentioning:</p>
<ul>
<li>The internal processing of <code>handleState</code> is very pure, not involving locks, channels, or other complex concurrency mechanisms. This pure logic is preserved for easy unit testing. Ideally, <code>handleState</code> should be side-effect free, only returning results based on input parameters (called a pure function).</li>
<li>Putting the lock at the outermost layer also makes the logic clearer, otherwise it&rsquo;s very easy to cause deadlocks, data races, and other concurrency issues.</li>
</ul>
<h1 id="three-way-handshake">Three-Way Handshake</h1>
<p>Actually, implementing a usable three-way handshake and four-way handshake process just requires understanding sequence and acknowledgment number calculation, and send/receive window calculation. With the above foundation, implementation becomes relatively straightforward.
The protocol handling entry point is written like this:</p>
<p><a href="https://github.com/beardnick/lab/blob/253c47fe4ca605942c5980f9f11427facf5501ec/network/netstack/socket/socket.go#L196-L243" target="_blank" rel="noopener noreffer ">socket.go#L196-L243</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">TcpSocket</span><span class="p">)</span> <span class="nf">handleState</span><span class="p">(</span><span class="nx">ipPack</span> <span class="o">*</span><span class="nx">tcpip</span><span class="p">.</span><span class="nx">IPPack</span><span class="p">,</span> <span class="nx">tcpPack</span> <span class="o">*</span><span class="nx">tcpip</span><span class="p">.</span><span class="nx">TcpPack</span><span class="p">)</span> <span class="p">(</span><span class="nx">resp</span> <span class="o">*</span><span class="nx">tcpip</span><span class="p">.</span><span class="nx">IPPack</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="nx">s</span><span class="p">.</span><span class="nx">State</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nx">tcpip</span><span class="p">.</span><span class="nx">TcpStateListen</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nx">s</span><span class="p">.</span><span class="nf">handleNewSocket</span><span class="p">(</span><span class="nx">ipPack</span><span class="p">,</span> <span class="nx">tcpPack</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nx">tcpip</span><span class="p">.</span><span class="nx">TcpStateSynSent</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">handleSynResp</span><span class="p">(</span><span class="nx">tcpPack</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">!</span><span class="nx">s</span><span class="p">.</span><span class="nf">checkSeqAck</span><span class="p">(</span><span class="nx">tcpPack</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;seq %d or ack %d invalid recvNext %d sendUnack %d sendNext %d&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">tcpPack</span><span class="p">.</span><span class="nx">SequenceNumber</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">tcpPack</span><span class="p">.</span><span class="nx">AckNumber</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">s</span><span class="p">.</span><span class="nx">recvNext</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">s</span><span class="p">.</span><span class="nx">sendUnack</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">s</span><span class="p">.</span><span class="nx">sendNext</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">switch</span> <span class="nx">s</span><span class="p">.</span><span class="nx">State</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nx">tcpip</span><span class="p">.</span><span class="nx">TcpStateClosed</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">tcpPack</span><span class="p">.</span><span class="nx">Flags</span><span class="o">&amp;</span><span class="nb">uint8</span><span class="p">(</span><span class="nx">tcpip</span><span class="p">.</span><span class="nx">TcpSYN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">handleSyn</span><span class="p">(</span><span class="nx">tcpPack</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nx">tcpip</span><span class="p">.</span><span class="nx">TcpStateSynReceived</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">tcpPack</span><span class="p">.</span><span class="nx">Flags</span><span class="o">&amp;</span><span class="nb">uint8</span><span class="p">(</span><span class="nx">tcpip</span><span class="p">.</span><span class="nx">TcpACK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">handleFirstAck</span><span class="p">(</span><span class="nx">tcpPack</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nx">tcpip</span><span class="p">.</span><span class="nx">TcpStateEstablished</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">tcpPack</span><span class="p">.</span><span class="nx">Flags</span><span class="o">&amp;</span><span class="nb">uint8</span><span class="p">(</span><span class="nx">tcpip</span><span class="p">.</span><span class="nx">TcpFIN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">handleFin</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">handleData</span><span class="p">(</span><span class="nx">tcpPack</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nx">tcpip</span><span class="p">.</span><span class="nx">TcpStateLastAck</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">tcpPack</span><span class="p">.</span><span class="nx">Flags</span><span class="o">&amp;</span><span class="nb">uint8</span><span class="p">(</span><span class="nx">tcpip</span><span class="p">.</span><span class="nx">TcpACK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">s</span><span class="p">.</span><span class="nf">handleLastAck</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nx">tcpip</span><span class="p">.</span><span class="nx">TcpStateCloseWait</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nx">tcpip</span><span class="p">.</span><span class="nx">TcpStateFinWait1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">handleFinWait1</span><span class="p">(</span><span class="nx">tcpPack</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nx">tcpip</span><span class="p">.</span><span class="nx">TcpStateFinWait2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">handleFinWait2Fin</span><span class="p">(</span><span class="nx">tcpPack</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;invalid state %d&#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The entry point is quite straightforward, just two big <code>switch</code> statements that call different handling functions based on the current connection state. Let&rsquo;s analyze these handling functions one by one.</p>
<h2 id="handling-syn-packet-in-passive-open">Handling SYN Packet in Passive Open</h2>
<p>Since there&rsquo;s no socket listening on [localIP, localPort, remoteIP, remotePort] when the SYN packet arrives, the SYN packet is handled by the socket listening on [localIP, localPort].
The handling logic is:</p>
<p><a href="https://github.com/beardnick/lab/blob/6365a837db2e19f3027e776692817eab51a01ad6/network/netstack/socket/socket.go#L210-L229" target="_blank" rel="noopener noreffer ">handleNewSocket</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">TcpSocket</span><span class="p">)</span> <span class="nf">handleFirstAck</span><span class="p">(</span><span class="nx">tcpPack</span> <span class="o">*</span><span class="nx">tcpip</span><span class="p">.</span><span class="nx">TcpPack</span><span class="p">)</span> <span class="p">(</span><span class="nx">resp</span> <span class="o">*</span><span class="nx">tcpip</span><span class="p">.</span><span class="nx">IPPack</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">s</span><span class="p">.</span><span class="nx">State</span> <span class="p">=</span> <span class="nx">tcpip</span><span class="p">.</span><span class="nx">TcpStateEstablished</span>
</span></span><span class="line"><span class="cl">    <span class="nx">s</span><span class="p">.</span><span class="nx">sendUnack</span> <span class="p">=</span> <span class="nx">tcpPack</span><span class="p">.</span><span class="nx">AckNumber</span>
</span></span><span class="line"><span class="cl">    <span class="nx">s</span><span class="p">.</span><span class="nx">synQueue</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">RemotePort</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nx">s</span><span class="p">.</span><span class="nx">listener</span><span class="p">.</span><span class="nx">acceptQueue</span> <span class="o">&lt;-</span> <span class="nx">s</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;accept queue is full, drop connection&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">s</span><span class="p">.</span><span class="nx">network</span><span class="p">.</span><span class="nf">addSocket</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">s</span><span class="p">.</span><span class="nx">network</span><span class="p">.</span><span class="nf">bindSocket</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">SocketAddr</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">fd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">go</span> <span class="nx">s</span><span class="p">.</span><span class="nf">runloop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">TcpSocket</span><span class="p">)</span> <span class="nf">checkSeqAck</span><span class="p">(</span><span class="nx">tcpPack</span> <span class="o">*</span><span class="nx">tcpip</span><span class="p">.</span><span class="nx">TcpPack</span><span class="p">)</span> <span class="p">(</span><span class="nx">valid</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">State</span> <span class="o">==</span> <span class="nx">tcpip</span><span class="p">.</span><span class="nx">TcpStateClosed</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">tcpPack</span><span class="p">.</span><span class="nx">SequenceNumber</span> <span class="o">!=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">recvNext</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">tcpPack</span><span class="p">.</span><span class="nx">Flags</span><span class="o">&amp;</span><span class="nb">uint8</span><span class="p">(</span><span class="nx">tcpip</span><span class="p">.</span><span class="nx">TcpACK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">sendUnack</span> <span class="o">==</span> <span class="nx">s</span><span class="p">.</span><span class="nx">sendNext</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">tcpPack</span><span class="p">.</span><span class="nx">AckNumber</span> <span class="o">==</span> <span class="nx">s</span><span class="p">.</span><span class="nx">sendNext</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">tcpPack</span><span class="p">.</span><span class="nx">AckNumber</span> <span class="p">&gt;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">sendUnack</span> <span class="o">&amp;&amp;</span> <span class="nx">tcpPack</span><span class="p">.</span><span class="nx">AckNumber</span> <span class="o">&lt;=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">sendNext</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Main logic:</p>
<ul>
<li>Verify sequence and acknowledgment numbers are correct. This is a common logic placed in the <code>checkSeqAck</code> function</li>
<li>Set connection state to <code>tcpip.TcpStateEstablished</code></li>
<li>Set <code>sendUnack</code> to the peer&rsquo;s acknowledgment number, as the peer sent ACK indicating they received the SYN</li>
<li>Remove current socket from <code>synQueue</code></li>
<li>Add current socket to <code>acceptQueue</code> as the connection is established. If <code>acceptQueue</code> is full, drop the connection and return directly</li>
<li>Add current socket to <code>Network</code>, listening on address <code>[localIP, localPort, remoteIP, remotePort]</code>. This address takes precedence over the listener&rsquo;s <code>[localIP, localPort]</code>, so subsequent requests will be handled by the current socket</li>
</ul>
<h2 id="connect"><code>connect()</code></h2>
<p>This is actively opening a connection. Implementation:</p>
<p><a href="https://github.com/beardnick/lab/blob/bda182aad77b7dc9890e73725b6d6957c436fad7/network/netstack/socket/net.go#L337-L369" target="_blank" rel="noopener noreffer ">connect</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">n</span> <span class="o">*</span><span class="nx">Network</span><span class="p">)</span> <span class="nf">connect</span><span class="p">(</span><span class="nx">fd</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">serverAddr</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">serverIP</span><span class="p">,</span> <span class="nx">serverPort</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">parseAddress</span><span class="p">(</span><span class="nx">serverAddr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">n</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nx">n</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sock</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">n</span><span class="p">.</span><span class="nf">getSocketByFd</span><span class="p">(</span><span class="nx">fd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;%w: %d&#34;</span><span class="p">,</span> <span class="nx">ErrNoSocket</span><span class="p">,</span> <span class="nx">fd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">addr</span> <span class="nx">SocketAddr</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">sock</span><span class="p">.</span><span class="nx">LocalIP</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">sock</span><span class="p">.</span><span class="nx">LocalPort</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">addr</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">n</span><span class="p">.</span><span class="nf">getAvailableAddress</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">n</span><span class="p">.</span><span class="nf">unbindSocket</span><span class="p">(</span><span class="nx">SocketAddr</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">LocalIP</span><span class="p">:</span>   <span class="nx">sock</span><span class="p">.</span><span class="nx">LocalIP</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">LocalPort</span><span class="p">:</span> <span class="nx">sock</span><span class="p">.</span><span class="nx">LocalPort</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl">        <span class="nx">addr</span> <span class="p">=</span> <span class="nx">SocketAddr</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">LocalIP</span><span class="p">:</span>   <span class="nx">sock</span><span class="p">.</span><span class="nx">LocalIP</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">LocalPort</span><span class="p">:</span> <span class="nx">sock</span><span class="p">.</span><span class="nx">LocalPort</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">addr</span><span class="p">.</span><span class="nx">RemoteIP</span> <span class="p">=</span> <span class="nx">serverIP</span><span class="p">.</span><span class="nf">String</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">addr</span><span class="p">.</span><span class="nx">RemotePort</span> <span class="p">=</span> <span class="nx">serverPort</span>
</span></span><span class="line"><span class="cl">    <span class="nx">n</span><span class="p">.</span><span class="nf">bindSocket</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">fd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">InitConnectSocket</span><span class="p">(</span><span class="nx">sock</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">sock</span><span class="p">.</span><span class="nf">Connect</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Main logic:</p>
<ul>
<li>Bind socket to <code>[localIP, localPort, remoteIP, remotePort]</code>. If <code>localIP</code> and <code>localPort</code> were specified during bind, use those; otherwise use randomly allocated ones from <code>Network</code></li>
<li>Initialize socket, setting itself as its own <code>listener</code></li>
</ul>
<p>Let&rsquo;s look at the <code>Socket.connect()</code> function:</p>
<p><a href="https://github.com/beardnick/lab/blob/6365a837db2e19f3027e776692817eab51a01ad6/network/netstack/socket/socket.go#L584-L628" target="_blank" rel="noopener noreffer ">connect</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">TcpSocket</span><span class="p">)</span> <span class="nf">connect</span><span class="p">()</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">err</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ipResp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">activeConnect</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">data</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ipResp</span><span class="p">.</span><span class="nf">Encode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">s</span><span class="p">.</span><span class="nx">network</span><span class="p">.</span><span class="nx">writeCh</span> <span class="o">&lt;-</span> <span class="nx">data</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;-</span><span class="nx">s</span><span class="p">.</span><span class="nx">acceptQueue</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">TcpSocket</span><span class="p">)</span> <span class="nf">activeConnect</span><span class="p">()</span> <span class="p">(</span><span class="nx">ipResp</span> <span class="o">*</span><span class="nx">tcpip</span><span class="p">.</span><span class="nx">IPPack</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">s</span><span class="p">.</span><span class="nx">State</span> <span class="p">=</span> <span class="nx">tcpip</span><span class="p">.</span><span class="nx">TcpStateSynSent</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">seq</span> <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">network</span><span class="p">.</span><span class="nx">opt</span><span class="p">.</span><span class="nx">Seq</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">seq</span> <span class="p">=</span> <span class="nb">uint32</span><span class="p">(</span><span class="nx">rand</span><span class="p">.</span><span class="nf">Int</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">seq</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">network</span><span class="p">.</span><span class="nx">opt</span><span class="p">.</span><span class="nx">Seq</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">s</span><span class="p">.</span><span class="nx">sendUnack</span> <span class="p">=</span> <span class="nx">seq</span>
</span></span><span class="line"><span class="cl">    <span class="nx">s</span><span class="p">.</span><span class="nx">sendNext</span> <span class="p">=</span> <span class="nx">seq</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">ipResp</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">NewPacketBuilder</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">network</span><span class="p">.</span><span class="nx">opt</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">        <span class="nf">SetAddr</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">SocketAddr</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">        <span class="nf">SetSeq</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">sendNext</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">        <span class="nf">SetFlags</span><span class="p">(</span><span class="nx">tcpip</span><span class="p">.</span><span class="nx">TcpSYN</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">        <span class="nf">Build</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">s</span><span class="p">.</span><span class="nx">sendNext</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">s</span><span class="p">.</span><span class="nx">listener</span> <span class="p">=</span> <span class="nx">s</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">ipResp</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Main logic:</p>
<ul>
<li>Set connection state to <code>tcpip.TcpStateSynSent</code></li>
<li>Send SYN packet</li>
<li>Block to get a socket from <code>acceptQueue</code>. The socket obtained will be the current socket, with the listener being the socket itself. The current socket listens on <code>[localIP, localPort, remoteIP, remotePort]</code>, there will only be one socket</li>
</ul>
<p>Other logic is the same as handling SYN packet in passive open, as they are symmetric.</p>
<h2 id="handling-synack-packet-in-active-open">Handling SYN+ACK Packet in Active Open</h2>
<p>Implementation:
<a href="https://github.com/beardnick/lab/blob/6365a837db2e19f3027e776692817eab51a01ad6/network/netstack/socket/socket.go#L261-L301" target="_blank" rel="noopener noreffer ">handleSynResp</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">TcpSocket</span><span class="p">)</span> <span class="nf">handleSynResp</span><span class="p">(</span><span class="nx">tcpPack</span> <span class="o">*</span><span class="nx">tcpip</span><span class="p">.</span><span class="nx">TcpPack</span><span class="p">)</span> <span class="p">(</span><span class="nx">resp</span> <span class="o">*</span><span class="nx">tcpip</span><span class="p">.</span><span class="nx">IPPack</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">tcpPack</span><span class="p">.</span><span class="nx">Flags</span><span class="o">&amp;</span><span class="nb">uint8</span><span class="p">(</span><span class="nx">tcpip</span><span class="p">.</span><span class="nx">TcpACK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">tcpPack</span><span class="p">.</span><span class="nx">Flags</span><span class="o">&amp;</span><span class="nb">uint8</span><span class="p">(</span><span class="nx">tcpip</span><span class="p">.</span><span class="nx">TcpSYN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// syn + ack expected
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// just drop the packet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;invalid packet, expected syn and ack, but get %s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">tcpip</span><span class="p">.</span><span class="nf">InspectFlags</span><span class="p">(</span><span class="nx">tcpPack</span><span class="p">.</span><span class="nx">Flags</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">tcpPack</span><span class="p">.</span><span class="nx">AckNumber</span> <span class="o">!=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">sendUnack</span><span class="o">+</span><span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;invalid packet, expected ack %d, but get %d&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">s</span><span class="p">.</span><span class="nx">sendUnack</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">tcpPack</span><span class="p">.</span><span class="nx">AckNumber</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">s</span><span class="p">.</span><span class="nx">State</span> <span class="p">=</span> <span class="nx">tcpip</span><span class="p">.</span><span class="nx">TcpStateEstablished</span>
</span></span><span class="line"><span class="cl">    <span class="nx">s</span><span class="p">.</span><span class="nx">recvNext</span> <span class="p">=</span> <span class="nx">tcpPack</span><span class="p">.</span><span class="nx">SequenceNumber</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">ipResp</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">NewPacketBuilder</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">network</span><span class="p">.</span><span class="nx">opt</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">        <span class="nf">SetAddr</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">SocketAddr</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">        <span class="nf">SetSeq</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">sendNext</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">        <span class="nf">SetAck</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">recvNext</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">        <span class="nf">SetFlags</span><span class="p">(</span><span class="nx">tcpip</span><span class="p">.</span><span class="nx">TcpACK</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">        <span class="nf">Build</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">s</span><span class="p">.</span><span class="nx">sendUnack</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nx">s</span><span class="p">.</span><span class="nx">listener</span><span class="p">.</span><span class="nx">acceptQueue</span> <span class="o">&lt;-</span> <span class="nx">s</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;accept queue is full, drop connection&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">ipResp</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Main logic:</p>
<ul>
<li>Verify it must be SYN+ACK packet</li>
<li>Verify acknowledgment number is correct. Since only SYN was sent, acknowledgment number must be <code>sendUnack+1</code></li>
<li>Set connection state to <code>tcpip.TcpStateEstablished</code></li>
<li>Set <code>recvNext</code> to peer&rsquo;s sequence number plus 1, as peer&rsquo;s SYN occupies one sequence number</li>
<li>Set <code>sendUnack</code> plus 1, as peer sent ACK indicating they received the SYN</li>
<li><code>sendNext</code> doesn&rsquo;t change as we only sent ACK, no data sent</li>
</ul>
<h1 id="accept"><code>accept()</code></h1>
<p>The accept function simply blocks to get a socket from <code>acceptQueue</code>, very simple implementation:</p>
<p><a href="https://github.com/beardnick/lab/blob/6365a837db2e19f3027e776692817eab51a01ad6/network/netstack/socket/socket.go#L78-L83" target="_blank" rel="noopener noreffer ">Accept</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">TcpSocket</span><span class="p">)</span> <span class="nf">Accept</span><span class="p">()</span> <span class="p">(</span><span class="nx">cfd</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">addr</span> <span class="nx">SocketAddr</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">cs</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">s</span><span class="p">.</span><span class="nx">acceptQueue</span>
</span></span><span class="line"><span class="cl">    <span class="nx">cs</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nx">cs</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">fd</span><span class="p">,</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">SocketAddr</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="summary">Summary</h1>
<p>Finally, we&rsquo;ve covered the three-way handshake. The three-way handshake has many details, but understanding sequence and acknowledgment numbers, and send/receive window calculation makes it relatively easy to understand.
My implementation is just a toy implementation of the three-way handshake. Production-level implementations are much more complex.
There are also many valuable topics in this article that we haven&rsquo;t expanded on, such as how thread safety is implemented and how to make the code more testable. I&rsquo;ll discuss these in separate articles later.
If you found this article helpful, please give it a like and follow me. Feel free to point out any errors. Also welcome to star my experimental project <a href="https://github.com/beardnick/lab" target="_blank" rel="noopener noreffer ">lab</a> and follow my GitHub page <a href="https://beardnick.github.io/qianz.github.io/" target="_blank" rel="noopener noreffer ">qianz</a>.</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2025-02-19</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/qianz.github.io/posts/write_tcp_ip_stack_by_yourself_3/index.md" target="_blank">Read Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://beardnick.github.io/qianz.github.io/posts/write_tcp_ip_stack_by_yourself_3/" data-title="Write TCP/IP Stack by Yourself (3): TCP Three-Way Handshake" data-hashtags="tcp/ip,network,linux"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://beardnick.github.io/qianz.github.io/posts/write_tcp_ip_stack_by_yourself_3/" data-hashtag="tcp/ip"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="https://beardnick.github.io/qianz.github.io/posts/write_tcp_ip_stack_by_yourself_3/" data-title="Write TCP/IP Stack by Yourself (3): TCP Three-Way Handshake"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="https://beardnick.github.io/qianz.github.io/posts/write_tcp_ip_stack_by_yourself_3/" data-title="Write TCP/IP Stack by Yourself (3): TCP Three-Way Handshake"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="https://beardnick.github.io/qianz.github.io/posts/write_tcp_ip_stack_by_yourself_3/" data-title="Write TCP/IP Stack by Yourself (3): TCP Three-Way Handshake"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/qianz.github.io/tags/tcp/ip/">Tcp/Ip</a>,&nbsp;<a href="/qianz.github.io/tags/network/">Network</a>,&nbsp;<a href="/qianz.github.io/tags/linux/">Linux</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/qianz.github.io/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/qianz.github.io/posts/write_tcp_ip_stack_by_yourself_2/" class="prev" rel="prev" title="Write TCP/IP Stack by Yourself (2): TCP Packet Generation"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Write TCP/IP Stack by Yourself (2): TCP Packet Generation</a>
            <a href="/qianz.github.io/posts/write_tcp_ip_stack_by_yourself_4/" class="next" rel="next" title="Write TCP/IP Stack by Yourself (4): TCP Data Transfer and Four-Way Handshake">Write TCP/IP Stack by Yourself (4): TCP Data Transfer and Four-Way Handshake<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.123.7">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2022 - 2025</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/qianz.github.io/" target="_blank">qianz</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{}};</script><script type="text/javascript" src="/qianz.github.io/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-R8VEWR2RP4', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-R8VEWR2RP4" async></script></body>
</html>
